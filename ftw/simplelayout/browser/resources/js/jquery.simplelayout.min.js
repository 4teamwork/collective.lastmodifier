/*! jquery.simplelayout 2014-09-15 */
!function(a){function b(){a("#auto-block-height").button({icons:{primary:"ui-icon-closethick"}}).change(function(){a(this).button("option",{icons:{primary:this.checked?"ui-icon-check":"ui-icon-closethick"}})}),a("#simplelayout-info-link").button({icons:{primary:"ui-icon-info"}}).prepOverlay({subtype:"ajax",filter:"#content"}),a("#simplelayout-help-link").button({icons:{primary:"ui-icon-help"}})}function c(b){b.bind("mouseenter",function(){var b=a(this),c=a(".block-wrapper",b);if(0===a(".sl-controls",b).length){var d=b.data("uuid");a.get("./sl-ajax-block-controls",{uuid:d},function(d){c.after(d),a(".sl-edit a",b).prepOverlay({subtype:"ajax",filter:"#content",formselector:"form",noform:function(a,b){var c=b.source.closest(".sl-block");return c.trigger("sl-block-reload"),"close"},closeselector:'[name="form.button.cancel"]',config:{onClose:function(a,c){c=a.currentTarget.getOverlay(),c.data("pbo").source.parents(".sl-block"),h(b),b.parents(".simplelayout").simplelayout("save")},onLoad:function(){window.initTinyMCE&&window.initTinyMCE(document)}}}),a(".sl-delete a").prepOverlay({subtype:"ajax",urlmatch:"$",urlreplace:" #content > *",formselector:'[action*="delete_confirmation"]',noform:function(a,b){var c=b.source.closest(".simplelayout");return b.source.closest(".sl-block").remove(),c.masonry("reload"),"close"},closeselector:'[name="form.button.Cancel"]'})})}else a(".sl-controls",b).toggle()}),b.bind("mouseleave",function(){a(".sl-controls",a(this)).toggle()})}function d(b){var d=b.data("simplelayout"),e=a("#add-block-link");void 0===e.data("events")&&e.button({icons:{primary:"ui-icon-plus"}}).on("click",function(e){if(e.stopPropagation(),e.preventDefault(),0===b.find(".sl-add-block").length){var g=a('<div style="width:'+d.contentwidth+'px" class="sl-add-block '+d.blocks.slice(1)+'"></div>');b.prepend(g),g.load("./@@addable-blocks-view",function(){a(".sl-addable-blocks a").prepOverlay({subtype:"ajax",filter:"#content",formselector:"form",noform:function(e){var h=a(".sl-block:not([style])",e);return h.attr("style",g.attr("style")),a(".sl-add-block").replaceWith(h),b!==h.parent()&&(b=h.parent()),b.masonry("reload",function(){b.simplelayout("save").simplelayout("layout")}),c(h),f(b,d),"close"},closeselector:'[name="form.buttons.cancel"]',config:{onLoad:function(){window.initTinyMCE&&window.initTinyMCE(document)}}}),b.simplelayout("layout"),b.masonry("reload")})}})}function e(b){function c(b,c){$block=b.parents(".sl-block"),a(".sl-img-wrapper",$block).css("float",c),a(".sl-img-wrapper img",$block).css("float",c),h($block),$block.parents(".simplelayout").simplelayout("save",function(){$block.trigger("sl-block-reload")})}var d=a('<span class="imagefloat left ui-icon ui-icon-arrowthickstop-1-w" />').hide(),e=a('<span class="imagefloat right ui-icon ui-icon-arrowthickstop-1-e" />').hide(),f=a('<span class="imagefloat none ui-icon ui-icon-arrowthick-2-e-w" />').hide(),g=a(".sl-img-wrapper",b);e.appendTo(g),d.appendTo(g),f.appendTo(g),g.on("mouseenter",function(b){b.preventDefault();var d=a(this),e=a(".imagefloat.left",d),f=a(".imagefloat.right",d),g=a(".imagefloat.none",d);e.on("click",function(){c(a(this),"left")}),f.on("click",function(){c(a(this),"right")}),g.on("click",function(){c(a(this),"none")});var h=a("img",d),i=h.css("float");"none"===i?(f.show(),e.show()):"left"===i?(f.show(),g.show()):"right"===i&&(e.show(),g.show())}).on("mouseleave",function(){var b=a(this),c=a(".imagefloat.left",b),d=a(".imagefloat.right",b),e=a(".imagefloat.none",b);d.unbind("click").hide(),c.unbind("click").hide(),e.unbind("click").hide()})}function f(b,d){var f=0,g=a(d.blocks+":has(.sl-inner-upload-area)",b);g.on("dragenter",function(){f++;var b=a(this),c=a(".sl-inner-upload-area",b);c.addClass("sl-upload-active")}),g.on("dragleave",function(){var b=a(this);console.info(f),0===--f&&a(".sl-inner-upload-area",b).removeClass("sl-upload-active")}),g.on("drop",function(d){d.stopPropagation(),d.preventDefault();var g=a(this);a(".sl-add-block",b).remove(),f=0;var i=d.originalEvent.dataTransfer.files,j=[].slice.call(i);g.simplelayoutuploader({files:j,statuscontainer:".sl-upload-active",form_data_callback:function(b,c){c.append("container_uuid",g.data("uuid")),c.append("contenttype",a("[data-contenttype]",g).data("contenttype"))},upload_success_all:function(b,d){var f=JSON.parse(d).uuid;a(".block-view-wrapper",b).load("./@@sl-ajax-reload-block-view",{uuid:f},function(){b.data("uuid",f),h(b),b.closest(".simplelayout").masonry("reload").simplelayout("save").simplelayout("layout"),c(b),e(b)})}})})}function g(b,d){var f=0;b.on("dragenter",function(c){if(f++,0===a(".sl-add-block",b).length){var e=c.originalEvent.dataTransfer.items;a.each(e,function(c,e){if(a.fn.simplelayoututils.is_image(e)){var f=a('<div style="width:'+a.fn.simplelayoututils.get_grid(d)+'px" class="sl-add-block '+d.blocks.slice(1)+'"><div class="block-wrapper"><div class="block-view-wrapper"> &nbsp; </div></div></div>');b.prepend(f)}}),b.masonry("reload")}}),b.on("drop",function(b){b.stopPropagation(),b.preventDefault();var d=b.originalEvent.dataTransfer.files,f=a(".sl-add-block",a(this)),g=[].slice.call(d);f.simplelayoutuploader({files:g,statuscontainer:".block-view-wrapper",form_data_callback:function(a,b){b.append("contenttype","ftw.simplelayout.TextBlock")},upload_success_each:function(b,d){var f=JSON.parse(d).uuid;a(".block-view-wrapper",b).load("./@@sl-ajax-reload-block-view",{uuid:f},function(){b.data("uuid",f),b.removeClass("sl-add-block"),h(b),b.closest(".simplelayout").masonry("reload").simplelayout("save").simplelayout("layout"),c(b),e(b)})}})}),b.on("dragleave",function(){0===--f&&(a(".sl-add-block",b).remove(),b.masonry("reload"))}),a(document).on("dragover",function(a){a.stopPropagation(),a.preventDefault()})}function h(b){if(1===a("#auto-block-height:checked").length)b.css("height","auto"),b.parent().masonry("reload",function(){b.css("height",b.height())});else{var c=b.height(),d=b.parents(".simplelayout").data("simplelayout"),e=a.fn.simplelayoututils.get_grid_height(d),f=c%e;f&&(new_height=c-f+e,b.css("height",new_height))}}var i={init:function(h){return this.each(function(){var i=a(this),j=i.data("simplelayout"),k=i.data("simplelayout-config");if(void 0!==k&&(h=k),"undefined"==typeof j){var l={blocks:".sl-block",columns:2,images:2,contentarea:"#content",margin_right:10,contentwidth:960,editable:!1};j=a.extend({},l,h)}else j=a.extend({},j,h);if(i.data("simplelayout",j),j.editable){var m=a(j.blocks,i);b(),c(m),e(m),g(i,j),f(i,j),d(i)}})},destroy:function(){return a(this).each(function(){var b=a(this),c=b.data("simplelayout");if("undefined"==typeof c)return void console.info('Initialize plugin first, using $("SELECTOR").simplelayout("init", options)');var d=a(c.blocks,b);b.removeData("simplelayout"),b.masonry("destroy"),c.editable&&(b.sortable("destroy"),d.resizable("destroy"),a(".sl-img-wrapper img",d).resizable("destroy"))})},add:function(){return this.each(function(){var b=a(this),c=b.data("simplelayout");return"undefined"==typeof c?void console.info('Initialize plugin first, using $("SELECTOR").simplelayout("init", options)'):void a("#add-block-link").click()})},layout:function(){return this.each(function(){var b=a(this),c=b.data("simplelayout");if("undefined"==typeof c)return void console.info('Initialize plugin first, using $("SELECTOR").simplelayout("init", options)');var d=a(c.blocks,b),f=a.fn.simplelayoututils.get_grid(c),g=a.fn.simplelayoututils.get_grid_height(c);if(a(".block-view-wrapper",d).css("margin-right",c.margin_right),b.css("max-width",c.contentwidth),b.masonry({itemSelector:c.blocks,isResizable:!0,columnWidth:f}),c.editable){b.css("width",c.contentwidth),d.each(function(){var d=a(this),f=d.data("events");(void 0===f||void 0===f["sl-block-reload"])&&d.on("sl-block-reload",{settings:c,container:b},a.fn.simplelayoututils.reload_block),(void 0===f||void 0===f["sl-block-reloaded"])&&d.on("sl-block-reloaded",function(b,c){var d=a(this);c.container.simplelayout("layout"),e(d),a(".sl-controls:visible",d).hide()})}),d.resizable({grid:[f,g],minWidth:f,maxWidth:c.contentwidth,resize:function(a,b){b.element.parent().masonry("reload")},stop:function(d,e){e.element.parent().masonry("reload",function(){var d=e.element.find("img");new_img_width=a.fn.simplelayoututils.get_image_width_based_on_block_width(d.width(),e.originalSize.width,e.element.width(),c),d.width(new_img_width).height("auto"),d.parent().width(new_img_width).height("auto"),d.parents(".sl-img-wrapper").width(new_img_width).height("auto"),h(e.element),b.simplelayout("save",function(){e.element.trigger("sl-block-reload")})})}});var i=a.fn.simplelayoututils.get_image_grid(c);a(".sl-img-wrapper img",d).resizable({handles:"e, w",zIndex:91,grid:[i,1],minWidth:i-c.margin_right,start:function(a,b){b.element.resizable("option","maxWidth",b.element.parents(".block-wrapper").width())},resize:function(a,b){var c=b.originalElement,d=c.attr("width")/c.attr("height"),e=b.element.width()/d;b.element.parent().height(e),b.element.parents(".sl-img-wrapper").height(e),b.element.height(e)},stop:function(a,c){var d=c.originalElement,e=d.parents(".sl-block");h(e),b.simplelayout("save",function(){e.trigger("sl-block-reload")})}}),b.sortable({distance:1,forcePlaceholderSize:!0,items:c.blocks,connectWith:"[id^=sl-slot-]",cursor:"move",delay:100,placeholder:{element:function(b){var c=a('<div class="block-sortable-placeholder sl-block"></div>');return c.css("width",b.css("width")),c.css("height",b.css("height")),c[0]},update:function(){}},tolerance:"pointer",start:function(b,c){c.item.addClass("dragging").removeClass("sl-block"),c.item.hasClass("bigun")&&c.placeholder.addClass("bigun"),a("[data-simplelayout-config]").masonry("reload")},change:function(){a("[data-simplelayout-config]").masonry("reload")},stop:function(a,b){b.item.removeClass("dragging").addClass("sl-block"),b.item.parent().masonry("reload",function(){b.item.parent().simplelayout("save").simplelayout("layout")})}})}})},save:function(b){return this.each(function(){var c=a(this),d=c.data("simplelayout");if("undefined"==typeof d)return void console.info('Initialize plugin first, using $("SELECTOR").simplelayout("init", options)');if(0===c.find(".sl-add-block").length){var e=a(d.blocks,c),f=[];e.each(function(b,d){var e=a(d),g=a("img",e),h=!1;0!==g.length&&(h="width:"+g.css("width")+";height: "+g.css("height")+";float: "+g.css("float")+";"),f.push({uuid:e.data("uuid"),slot:c.attr("id"),position:e.position(),size:{width:e.width(),height:e.height()},imagestyles:h})}),a.ajax("./sl-ajax-save-state",{cache:!1,data:{payload:JSON.stringify(f)},dataType:"json",type:"POST",success:function(a){"function"==typeof b&&b.call(this,a)},error:function(a,b,c){alert(b,c)}})}})}};a.fn.simplelayoututils={get_grid:function(a){return a.contentwidth/a.columns},get_image_grid:function(a){return a.contentwidth/a.columns/a.images},get_grid_height:function(b){return parseInt(a(b.contentarea).css("font-size").slice(0,2))},is_image:function(a){return 0===a.type.indexOf("image")},reload_block:function(b){var c=a(this),d=c.data("uuid");a(".block-view-wrapper",c).load("./@@sl-ajax-reload-block-view",{uuid:d},function(){c.trigger("sl-block-reloaded",{settings:b.data.settings,container:b.data.container})})},get_image_width_based_on_block_width:function(b,c,d,e){var f,g=a.fn.simplelayoututils.get_grid(e),h=a.fn.simplelayoututils.get_image_grid(e),i=c/g,j=d/g,k=j-i,l=(b+e.margin_right)/h,m=l+k;return f=1>m?h-e.margin_right:l/e.images===i?j*e.images*h-e.margin_right:m/e.images>j?j*e.images*h-e.margin_right:m*h-e.margin_right}},a.fn.simplelayout=function(){var b=arguments[0];if(i[b])b=i[b],arguments=Array.prototype.slice.call(arguments,1);else{if("object"!=typeof b&&b)return a.error("Method "+b+" does not exist on jQuery.pluginName"),this;b=i.init}return b.apply(this,arguments)}}(jQuery);