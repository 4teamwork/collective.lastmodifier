/*! jquery.simplelayout 2014-07-09 */
!function(a){function b(){a("#auto-block-height").button({icons:{primary:"ui-icon-closethick"}}).change(function(){a(this).button("option",{icons:{primary:this.checked?"ui-icon-check":"ui-icon-closethick"}})}),a("#simplelayout-info-link").button({icons:{primary:"ui-icon-info"}}).prepOverlay({subtype:"ajax",filter:"#content"}),a("#simplelayout-help-link").button({icons:{primary:"ui-icon-help"}})}function c(a){return a.contentwidth/a.columns}function d(a){return a.contentwidth/a.columns/a.images}function e(a){return 0===a.type.indexOf("image")}function f(b){return a(b.contentarea).css("font-size").slice(0,2)}function g(b){var c=a(this),d=c.data("uuid");a(".block-view-wrapper",c).load("./@@sl-ajax-reload-block-view",{uuid:d},function(){c.trigger("sl-block-reloaded",{settings:b.data.settings,container:b.data.container})})}function h(b){b.bind("mouseenter",function(){var b=a(this),c=a(".block-wrapper",b);if(0===a(".sl-controls",b).length){var d=b.data("uuid");a.get("./sl-ajax-block-controls",{uuid:d},function(d){c.after(d),a(".sl-edit a",b).prepOverlay({subtype:"ajax",filter:"#content",formselector:"form",noform:function(a,b){var c=b.source.closest(".sl-block");return c.trigger("sl-block-reload"),"close"},closeselector:'[name="form.button.cancel"]',config:{onClose:function(a,c){c=a.currentTarget.getOverlay(),c.data("pbo").source.parents(".sl-block"),m(b),b.parents(".simplelayout").simplelayout("save")},onLoad:function(){window.initTinyMCE&&window.initTinyMCE(document)}}}),a(".sl-delete a").prepOverlay({subtype:"ajax",urlmatch:"$",urlreplace:" #content > *",formselector:'[action*="delete_confirmation"]',noform:function(a,b){var c=b.source.closest(".simplelayout");return b.source.closest(".sl-block").remove(),c.masonry("reload"),"close"},closeselector:'[name="form.button.Cancel"]'})})}else a(".sl-controls",b).toggle()}),b.bind("mouseleave",function(){a(".sl-controls",a(this)).toggle()})}function i(b){var c=b.data("simplelayout"),d=a("#add-block-link");void 0===d.data("events")&&d.button({icons:{primary:"ui-icon-plus"}}).on("click",function(d){if(d.stopPropagation(),d.preventDefault(),0===b.find(".sl-add-block").length){var e=a('<div style="width:'+c.contentwidth+'px" class="sl-add-block '+c.blocks.slice(1)+'"></div>');b.prepend(e),e.load("./@@addable-blocks-view",function(){a(".sl-addable-blocks a").prepOverlay({subtype:"ajax",filter:"#content",formselector:"form",noform:function(d){var f=a(".sl-block:not([style])",d);return f.attr("style",e.attr("style")),a(".sl-add-block").replaceWith(f),b!==f.parent()&&(b=f.parent()),b.masonry("reload",function(){b.simplelayout("save").simplelayout("layout")}),h(f),k(b,c),"close"},closeselector:'[name="form.buttons.cancel"]',config:{onLoad:function(){window.initTinyMCE&&window.initTinyMCE(document)}}}),b.simplelayout("layout"),b.masonry("reload")})}})}function j(b){function c(b,c){$block=b.parents(".sl-block"),a(".sl-img-wrapper",$block).css("float",c),a(".sl-img-wrapper img",$block).css("float",c),m($block),$block.parents(".simplelayout").simplelayout("save",function(){$block.trigger("sl-block-reload")})}var d=a('<span class="imagefloat left ui-icon ui-icon-arrowthickstop-1-w" />').hide(),e=a('<span class="imagefloat right ui-icon ui-icon-arrowthickstop-1-e" />').hide(),f=a('<span class="imagefloat none ui-icon ui-icon-arrowthick-2-e-w" />').hide(),g=a(".sl-img-wrapper",b);e.appendTo(g),d.appendTo(g),f.appendTo(g),g.on("mouseenter",function(b){b.preventDefault();var d=a(this),e=a(".imagefloat.left",d),f=a(".imagefloat.right",d),g=a(".imagefloat.none",d);e.on("click",function(){c(a(this),"left")}),f.on("click",function(){c(a(this),"right")}),g.on("click",function(){c(a(this),"none")});var h=a("img",d),i=h.css("float");"none"===i?(f.show(),e.show()):"left"===i?(f.show(),g.show()):"right"===i&&(e.show(),g.show())}).on("mouseleave",function(){var b=a(this),c=a(".imagefloat.left",b),d=a(".imagefloat.right",b),e=a(".imagefloat.none",b);d.unbind("click").hide(),c.unbind("click").hide(),e.unbind("click").hide()})}function k(b,c){var d=0,e=a(c.blocks+":has(.sl-inner-upload-area)",b);e.on("dragenter",function(){d++;var b=a(this),c=a(".sl-inner-upload-area",b);c.addClass("sl-upload-active")}),e.on("dragleave",function(){var b=a(this);console.info(d),0===--d&&a(".sl-inner-upload-area",b).removeClass("sl-upload-active")}),e.on("drop",function(c){c.stopPropagation(),c.preventDefault();var e=a(this);a(".sl-add-block",b).remove(),d=0;var f=c.originalEvent.dataTransfer.files,g=[].slice.call(f);e.simplelayoutuploader({files:g,statuscontainer:".sl-upload-active",form_data_callback:function(b,c){c.append("container_uuid",e.data("uuid")),c.append("contenttype",a("[data-contenttype]",e).data("contenttype"))},upload_success_all:function(b,c){var d=JSON.parse(c).uuid;a(".block-view-wrapper",b).load("./@@sl-ajax-reload-block-view",{uuid:d},function(){b.data("uuid",d),m(b),b.closest(".simplelayout").masonry("reload").simplelayout("save").simplelayout("layout"),h(b),j(b)})}})})}function l(b,d){var f=0;b.on("dragenter",function(g){if(f++,0===a(".sl-add-block",b).length){var h=g.originalEvent.dataTransfer.items;a.each(h,function(f,g){if(e(g)){var h=a('<div style="width:'+c(d)+'px" class="sl-add-block '+d.blocks.slice(1)+'"><div class="block-wrapper"><div class="block-view-wrapper"> &nbsp; </div></div></div>');b.prepend(h)}}),b.masonry("reload")}}),b.on("drop",function(b){b.stopPropagation(),b.preventDefault();var c=b.originalEvent.dataTransfer.files,d=a(".sl-add-block",a(this)),e=[].slice.call(c);d.simplelayoutuploader({files:e,statuscontainer:".block-view-wrapper",form_data_callback:function(a,b){b.append("contenttype","ftw.simplelayout.TextBlock")},upload_success_each:function(b,c){var d=JSON.parse(c).uuid;a(".block-view-wrapper",b).load("./@@sl-ajax-reload-block-view",{uuid:d},function(){b.data("uuid",d),b.removeClass("sl-add-block"),m(b),b.closest(".simplelayout").masonry("reload").simplelayout("save").simplelayout("layout"),h(b),j(b)})}})}),b.on("dragleave",function(){0===--f&&(a(".sl-add-block",b).remove(),b.masonry("reload"))}),a(document).on("dragover",function(a){a.stopPropagation(),a.preventDefault()})}function m(b){if(1===a("#auto-block-height:checked").length)b.css("height","auto"),b.parent().masonry("reload",function(){b.css("height",b.height())});else{var c=b.height(),d=b.parents(".simplelayout").data("simplelayout"),e=parseInt(f(d)),g=c%e;g&&(new_height=c-g+e,b.css("height",new_height))}}var n={init:function(c){return this.each(function(){var d=a(this),e=d.data("simplelayout"),f=d.data("simplelayout-config");if(void 0!==f&&(c=f),"undefined"==typeof e){var g={blocks:".sl-block",columns:2,images:2,contentarea:"#content",margin_right:10,contentwidth:960,editable:!1};e=a.extend({},g,c)}else e=a.extend({},e,c);if(d.data("simplelayout",e),e.editable){var m=a(e.blocks,d);b(),h(m),j(m),l(d,e),k(d,e),i(d)}})},destroy:function(){return a(this).each(function(){var b=a(this),c=b.data("simplelayout");if("undefined"==typeof c)return void console.info('Initialize plugin first, using $("SELECTOR").simplelayout("init", options)');var d=a(c.blocks,b);b.removeData("simplelayout"),b.masonry("destroy"),c.editable&&(b.sortable("destroy"),d.resizable("destroy"),a(".sl-img-wrapper img",d).resizable("destroy"))})},add:function(){return this.each(function(){var b=a(this),c=b.data("simplelayout");return"undefined"==typeof c?void console.info('Initialize plugin first, using $("SELECTOR").simplelayout("init", options)'):void a("#add-block-link").click()})},layout:function(){return this.each(function(){var b=a(this),e=b.data("simplelayout");if("undefined"==typeof e)return void console.info('Initialize plugin first, using $("SELECTOR").simplelayout("init", options)');var h=a(e.blocks,b),i=c(e);if(a(".block-view-wrapper",h).css("margin-right",e.margin_right),b.css("max-width",e.contentwidth),b.masonry({itemSelector:e.blocks,isResizable:!0,columnWidth:i}),e.editable){b.css("width",e.contentwidth),h.each(function(){var c=a(this),d=c.data("events");(void 0===d||void 0===d["sl-block-reload"])&&c.on("sl-block-reload",{settings:e,container:b},g),(void 0===d||void 0===d["sl-block-reloaded"])&&c.on("sl-block-reloaded",function(b,c){var d=a(this);c.container.simplelayout("layout"),j(d),a(".sl-controls:visible",d).hide()})}),h.resizable({grid:[i,f(e)],minWidth:i,maxWidth:e.contentwidth,resize:function(a,b){b.element.parent().masonry("reload")},stop:function(a,c){c.element.parent().masonry("reload",function(){var a,f=c.element.find("img"),g=d(e),h=c.originalSize.width/i,j=c.element.width()/i,k=j-h,l=(f.width()+e.margin_right)/g,n=l+k;a=1>n?g-e.margin_right:l/e.images===h?j*e.images*g-e.margin_right:n/e.images>j?j*e.images*g-e.margin_right:n*g-e.margin_right,f.width(a).height("auto"),f.parent().width(a).height("auto"),f.parents(".sl-img-wrapper").width(a).height("auto"),m(c.element),b.simplelayout("save",function(){c.element.trigger("sl-block-reload")})})}});var k=d(e);a(".sl-img-wrapper img",h).resizable({handles:"e, w",zIndex:91,grid:[k,1],minWidth:k-e.margin_right,start:function(a,b){b.element.resizable("option","maxWidth",b.element.parents(".block-wrapper").width())},resize:function(a,b){var c=b.originalElement,d=c.attr("width")/c.attr("height"),e=b.element.width()/d;b.element.parent().height(e),b.element.parents(".sl-img-wrapper").height(e),b.element.height(e)},stop:function(a,c){var d=c.originalElement,e=d.parents(".sl-block");m(e),b.simplelayout("save",function(){e.trigger("sl-block-reload")})}}),b.sortable({distance:1,forcePlaceholderSize:!0,items:e.blocks,connectWith:"[id^=sl-slot-]",cursor:"move",delay:100,placeholder:{element:function(b){var c=a('<div class="block-sortable-placeholder sl-block"></div>');return c.css("width",b.css("width")),c.css("height",b.css("height")),c[0]},update:function(){}},tolerance:"pointer",start:function(b,c){c.item.addClass("dragging").removeClass("sl-block"),c.item.hasClass("bigun")&&c.placeholder.addClass("bigun"),a("[data-simplelayout-config]").masonry("reload")},change:function(){a("[data-simplelayout-config]").masonry("reload")},stop:function(a,b){b.item.removeClass("dragging").addClass("sl-block"),b.item.parent().masonry("reload",function(){b.item.parent().simplelayout("save").simplelayout("layout")})}})}})},save:function(b){return this.each(function(){var c=a(this),d=c.data("simplelayout");if("undefined"==typeof d)return void console.info('Initialize plugin first, using $("SELECTOR").simplelayout("init", options)');if(0===c.find(".sl-add-block").length){var e=a(d.blocks,c),f=[];e.each(function(b,d){var e=a(d),g=a("img",e),h=!1;0!==g.length&&(h="width:"+g.css("width")+";height: "+g.css("height")+";float: "+g.css("float")+";"),f.push({uuid:e.data("uuid"),slot:c.attr("id"),position:e.position(),size:{width:e.width(),height:e.height()},imagestyles:h})}),a.ajax("./sl-ajax-save-state",{cache:!1,data:{payload:JSON.stringify(f)},dataType:"json",type:"POST",success:function(a){"function"==typeof b&&b.call(this,a)},error:function(a,b,c){alert(b,c)}})}})}};a.fn.simplelayout=function(){var b=arguments[0];if(n[b])b=n[b],arguments=Array.prototype.slice.call(arguments,1);else{if("object"!=typeof b&&b)return a.error("Method "+b+" does not exist on jQuery.pluginName"),this;b=n.init}return b.apply(this,arguments)}}(jQuery);